---
title: "Moccasin Measles Improved Visualisation"
format: html
author: "Kenny Low Wei Lun, Seah Yi Long Clarence, Lee Wen Qiang, Karianne Lai Wei Xuan, Goh Jia Rui Gary, Lim Jun Jie, Toh Li En"
date: "01/06/2025"
---

```{r}
#| label: necessary libraries
library(ggplot2)
library(tidyverse)
library(usmap)
library(readxl)
library(dplyr)
library(stringr)
```

```{r}
#| label: data preprocessing
# Load measles data
measles_df <- read.csv("measles_cases.csv")
measles_df <- measles_df[, c("State", "Confirmed.Cases")]
measles_df$State <- str_trim(measles_df$State)

# Load population Excel data (skip first 4 rows)
pop_raw <- read_excel("SCPRC-EST2024-18+POP.xlsx", skip = 4, col_names = FALSE)

# Extract and clean State and Population columns
population_df <- data.frame(State = pop_raw[[1]], Population = pop_raw[[2]])
population_df$State <- str_remove(population_df$State, "^\\.+")
population_df$State <- str_trim(population_df$State)
population_df$Population <- as.numeric(population_df$Population)

# Filter out non-state entries and NA values
exclude_states <- c("United States", "Northeast", "Midwest", "South", "West", "Puerto Rico")
population_df <- population_df[!(population_df$State %in% exclude_states), ]
population_df <- population_df[!is.na(population_df$Population), ]

# Merge data on State
merged_df <- merge(population_df, measles_df, by = "State", all.x = TRUE)

# Change NA to 0 for confirmed cases
merged_df$Confirmed.Cases[is.na(merged_df$Confirmed.Cases)] <- 0

# Calculate severity rate per 100,000 population
merged_df$Severity <- (merged_df$Confirmed.Cases / merged_df$Population) * 100000

# Optional: round to 2 decimal places
merged_df$Severity <- round(merged_df$Severity, 2)

# View result
print(merged_df)
```
```{r}
# Ensure state names match map data — convert to lowercase for safety
merged_df$State <- tolower(merged_df$State)

# usmap uses full state names or abbreviations — ensure compatibility
# Convert full state names to abbreviations
merged_df$fips <- fips(merged_df$State)

# Merge with usmap data by state name
plot_data <- merged_df[, c("State", "Severity")]
names(plot_data)[names(plot_data) == "State"] <- "state"  # lowercase required by usmap

# Plot severity map
plot_usmap(data = plot_data, values = "Severity", regions = "states", labels = TRUE) +
  scale_fill_continuous(
    low = "white", high = "red", 
    name = "Measles Cases per 100K",
    label = scales::comma
  ) +
  theme(legend.position = "right") +
  labs(title = "Measles Severity by State")
```